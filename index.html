<!DOCTYPE html>
<html>
	<head>
		<title>Chat</title>
		<meta charset="utf-8"/>	
		<link rel="stylesheet" href="css/main.css">
	</head>	

	<body>
		
		<div id="login">
			<form id="login_form">			
				Login : <input type="text" id="username"/>					
			</form>
		</div>	
	
		<div id="chat">
			<div id="texte"></div>
			<form id="form">
				<input id="msg" type="text" autocomplete="off"/>	
			</form>
		</div>		
	
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
      	<script>
			$(() => {
				$('#chat').hide();

				$('#login_form').submit(e => {
					e.preventDefault();

					let username = $('#username').val();
					
					// Si l'username saisie n'est pas valide, on ne fait rien
					if(username === '') return;					
					
					$('#login').fadeOut();
					$('#chat').fadeIn();					
					
					let socket = io.connect('http://127.0.0.1:8080');    	
					socket.emit('connected', {uname: username});				
				
					// On se connecte au serveur de chat
					$("#form").submit(e => {
						e.preventDefault();
						
						let msg = $('#msg').val();
						
						if(msg != '') 
						{
							socket.emit('sendmsg', {uname: username, message: msg});  
							$('#msg').val('');				
						}
  					});	
							
					// Evenement lorsqu'on envoie un nouveau message
					socket.on('newmsg', data => {
						if(data.uname === username)
						{
							$('#texte').append('<div class="perso"><strong>' + timestamp() + ' ' + data.uname + ':</strong> ' + data.message + '</div>');
							$('#texte').scrollTop($('#texte')[0].scrollHeight);
						} 
						else 
						{
							$('#texte').append('<div><strong>' + timestamp() + ' ' + data.uname + ':</strong> ' + data.message + '</div>');
							$('#texte').scrollTop($('#texte')[0].scrollHeight);
						}						      				
					});
				
					// Evenement lorsqu'on reçoit un message système
					socket.on('sysmsg', data => {
						$('#texte').append('<div class="sys">' + timestamp() + data.message + '</div>');
						$('#texte').scrollTop($('#texte')[0].scrollHeight);
					});
			  
					// Evenement lorsqu'on se déconnecte
					socket.on('disconnect', () => {
						$('#texte').append('<div class="sys">' + timestamp() + 'You\'ve been disconnected from the server.' + '</div>');
      					$('#texte').scrollTop($('#texte')[0].scrollHeight);
					});      			
				  
					// Fonctions qui calcule un timestamp
					let timestamp = () => {
						let date = new Date();
						let timestamp = '[' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + '] ';    
						
						return timestamp;
					};
				});
			});
      	</script>			
	</body>
</html>